#!/bin/bash
set -euo pipefail

# --- List of users to create ---
USERS=(
  "oemmanuelnoc"
  "jeisonnoc"
  "tarek-knoxxidev"
)

for NEW_USER in "${USERS[@]}"; do
  echo "===== Setting up user: $NEW_USER ====="

  USER_HOME="/home/$NEW_USER"
  SSH_DIR="$USER_HOME/.ssh"
  PRIVATE_KEY="$SSH_DIR/id_rsa"
  PUBLIC_KEY="${PRIVATE_KEY}.pub"
  RENAMED_PRIVATE_KEY="$SSH_DIR/${NEW_USER}_rsa"
  AUTHORIZED_KEYS="$SSH_DIR/authorized_keys"
  SUDO_FILE="/etc/sudoers.d/${NEW_USER}"

  # --- Create user if not exists ---
  if id "$NEW_USER" &>/dev/null; then
    echo "User '$NEW_USER' already exists. Skipping user creation."
  else
    adduser --disabled-password --gecos "" "$NEW_USER"
    echo "User '$NEW_USER' created."
  fi

  # --- Add user to sudo group ---
  usermod -aG sudo "$NEW_USER"
  echo "User '$NEW_USER' added to sudo group."

  # --- Grant passwordless sudo ---
  echo "$NEW_USER ALL=(ALL) NOPASSWD:ALL" > "$SUDO_FILE"
  chmod 440 "$SUDO_FILE"
  echo "Passwordless sudo enabled for $NEW_USER."

  # --- Create .ssh folder ---
  mkdir -p "$SSH_DIR"
  chmod 700 "$SSH_DIR"
  chown "$NEW_USER:$NEW_USER" "$SSH_DIR"

  # --- Generate SSH key ---
  if [[ ! -f "$PRIVATE_KEY" ]]; then
    sudo -u "$NEW_USER" ssh-keygen -t rsa -b 4096 -f "$PRIVATE_KEY" -N "" -q
    echo "SSH keypair created for $NEW_USER."
  else
    echo "SSH key already exists for $NEW_USER."
  fi

  # --- Rename keys ---
  mv "$PRIVATE_KEY" "$RENAMED_PRIVATE_KEY"
  mv "$PUBLIC_KEY" "${RENAMED_PRIVATE_KEY}.pub"
  echo "Keys renamed to ${NEW_USER}_rsa and ${NEW_USER}_rsa.pub"

  # --- Configure authorized_keys ---
  cp "${RENAMED_PRIVATE_KEY}.pub" "$AUTHORIZED_KEYS"
  chmod 600 "$AUTHORIZED_KEYS"
  chown "$NEW_USER:$NEW_USER" "$AUTHORIZED_KEYS"
  echo "authorized_keys updated for $NEW_USER"

  echo "===== Completed setup for $NEW_USER ====="
  echo
done

echo "ðŸŽ‰ All users created successfully with passwordless sudo!"
