#!/bin/bash

set -euo pipefail

# --- Variables ---
NEW_USER="osamuel-cnettdevops"
USER_HOME="/home/$NEW_USER"
SSH_DIR="$USER_HOME/.ssh"

PRIVATE_KEY="$SSH_DIR/id_rsa"
PUBLIC_KEY="${PRIVATE_KEY}.pub"

RENAMED_PRIVATE_KEY="$SSH_DIR/${NEW_USER}_rsa"
RENAMED_PUBLIC_KEY="${RENAMED_PRIVATE_KEY}.pub"

AUTHORIZED_KEYS="$SSH_DIR/authorized_keys"
SUDO_FILE="/etc/sudoers.d/$NEW_USER"

echo "ðŸš€ Starting setup for user: $NEW_USER"
echo

# --- Ensure script is run as root ---
if [[ $EUID -ne 0 ]]; then
  echo "âŒ Please run this script as root or with sudo."
  exit 1
fi

# --- Create user (if not exists) ---
if id "$NEW_USER" &>/dev/null; then
  echo "User '$NEW_USER' already exists. Skipping creation."
else
  adduser --disabled-password --gecos "" "$NEW_USER"
  echo "User '$NEW_USER' created successfully."
fi

# --- Ensure .ssh directory exists ---
mkdir -p "$SSH_DIR"
chmod 700 "$SSH_DIR"
chown "$NEW_USER:$NEW_USER" "$SSH_DIR"

# --- Generate SSH key pair if missing ---
if [ ! -f "$PRIVATE_KEY" ] && [ ! -f "$RENAMED_PRIVATE_KEY" ]; then
  sudo -u "$NEW_USER" ssh-keygen -t rsa -b 2048 -f "$PRIVATE_KEY" -N "" -q
  echo "SSH key pair generated."
else
  echo "SSH key pair already exists. Skipping generation."
fi

# --- Rename key files (if needed) ---
if [ -f "$PRIVATE_KEY" ] && [ ! -f "$RENAMED_PRIVATE_KEY" ]; then
  mv "$PRIVATE_KEY" "$RENAMED_PRIVATE_KEY"
  mv "$PUBLIC_KEY" "$RENAMED_PUBLIC_KEY"
  echo "Keys renamed to ${NEW_USER}_rsa and ${NEW_USER}_rsa.pub."
fi

# --- Add public key to authorized_keys ---
if [ -f "$RENAMED_PUBLIC_KEY" ]; then
  cat "$RENAMED_PUBLIC_KEY" > "$AUTHORIZED_KEYS"
  chmod 600 "$AUTHORIZED_KEYS"
  chown "$NEW_USER:$NEW_USER" "$AUTHORIZED_KEYS"
  echo "Public key added to authorized_keys."
fi

# --- Configure passwordless sudo ---
if [ ! -f "$SUDO_FILE" ]; then
  echo "$NEW_USER ALL=(ALL) NOPASSWD:ALL" > "$SUDO_FILE"
  chmod 440 "$SUDO_FILE"
  echo "Passwordless sudo enabled for $NEW_USER."
else
  echo "Passwordless sudo already configured."
fi

# --- Final ownership fix ---
chown -R "$NEW_USER:$NEW_USER" "$SSH_DIR"

echo
echo "âœ… Setup completed successfully!"
echo "   User: $NEW_USER"
echo "   SSH directory: $SSH_DIR"
echo "   Private key: $RENAMED_PRIVATE_KEY"
echo
